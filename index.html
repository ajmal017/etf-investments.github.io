

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <title>ETF Flows</title>
    <link rel="icon" href="https://d3v3cbxkdlyonc.cloudfront.net/stocks/favicon.ico">
    <meta name="description" content="ETF Flow Monitor">

    <!-- Update your html tag to include the itemscope and itemtype attributes. -->
    <html itemscope itemtype="http://schema.org/FinancialService">

    <!-- Place this data between the <head> tags of your website -->
    <title>ETF Flow and Return Momentum Monitor and Signals</title>
    <meta name="description" content="Monitor ETF prices and money flows acoss sectors, factors, investment styles and countries. " />

    <!-- Schema.org markup for Google+ -->
    <meta itemprop="name" content="ETF Flow and Return Momentum Monitor and Signals">
    <meta itemprop="description" content="Monitor ETF prices and money flows acoss sectors, factors, investment styles and countries. "">


    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Oxygen", "Ubuntu", "Helvetica Neue", Arial, sans-serif;

      }
      table { font-family: Courier, monospace; }
      .stocks-container {
        margin-bottom: 1.5em;
        width: 100%;
        max-width: 600px;
      }
      .stocks-container a { text-decoration: none; }
      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 0.9em;
      }
      .stock-symbol {
        width: 12%;
        padding: 2px 4px 2px 0px;
      }
      .stock-category, .stock-price, .stock-change, .stock-change-pct, .stock-mkt-cap , .stock-latest-volume, .stock-avg-total-volume,
      .flow-yesterday, .flow-1m, .flow-3m, .stock-change-pct-1m, .stock-change-pct-3m {
        width: 22%;
        text-align: right;
        padding: 2px 4px;
      }
      @media (max-width: 576px) {
        table { margin-bottom: 3em; }
        .stock-mkt-cap { display: none; }
        .stock-symbol { width: 16%; }
        .stock-price, .stock-change, .stock-change-pct { width: 28%; }
        td.stock-symbol, td.stock-price, td.stock-change, td.stock-change-pct {
          padding-top: 1em;
          padding-bottom: 1em;
        }
      }
      summary:hover { cursor: pointer; }
      summary::-webkit-details-marker { display: none; }
    </style>


  <script type="text/javascript" src="universe.json"></script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<script>
	  (adsbygoogle = window.adsbygoogle || []).push({
	    google_ad_client: "ca-pub-1243516152836996",
	    enable_page_level_ads: true
	  });
	</script>
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-116174436-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-116174436-1');
	</script>

  </head>

  <body>
    <h1> ETF Price and Flow Monitor </h1>
    <p class="updated-timestamp"></p>
    <p> 
      ETFs allow us to monitor prices and money flows acoss sectors, factors, investment styles and countries. This page monitors flows across a select set of ETFs. Flows are calculated for yesterday, last 1 month and last 3 months. Monitoring flows and returns allows us to understand where money is moving and may help us discern whether returns are driven by flows or fundamentals. 
    <p>

    <div class="stocks-container"></div>

    <p class="attribution">
      Data provided for free by <a href="https://iextrading.com/developer/" target="_blank">IEX</a>.
      Subject to <a href="https://iextrading.com/api-exhibit-a/" target="_blank">IEX Exhibit A</a>.
    </p>

    <p> 
         Idea and code adapted from <a href="https://github.com/toddwschneider/stocks">https://github.com/toddwschneider/stocks</a>
	</p>
	<p><a href="mailto:trade@etf.investments">Learn More </a></p>


    <p class="updated-timestamp"></p>



    <script>
      'use strict';

      var range  = r => Array.apply(null, Array(r)).map(function (_, i) {return i;});

      function addSortableLogic() {
        var ts = document.getElementsByClassName("sortable");
        for (var i in range(ts.length)){
          var th = ts[i].getElementsByTagName("th");
          for(var i2 in range(th.length)){
            th[i2].innerHTML = "<a href='' onClick=\"return sortTable('" + ts[i].id + "', " + i2 +");\">" + th[i2].innerHTML + '</a>';
            th[i2].style.cursor = "pointer";  
            th[i2].sortDir = 'desc';        
           }
        }
      }      

      const PORTFOLIOS = portfoliosFromQueryParams() || DEFAULT_PORTFOLIOS;
      const REFRESH_SECONDS = 25;
      const BATCH_SIZE = 100;
      const BASE_URL = 'https://api.iextrading.com/1.0/stock/market/batch';

      let symbols = [];
      let containerDiv = document.querySelector('.stocks-container');
      let updatedDiv = document.querySelector('.updated-timestamp');

      PORTFOLIOS.forEach((p, i) => addPortfolio(p, i));
      symbols = symbols.filter((s, i) => symbols.indexOf(s) === i);
      updateData('addTitle');
      setInterval(updateData, REFRESH_SECONDS * 1000);
      addSortableLogic();

      function addPortfolio(portfolio, portfolio_index) {


        let tableHeaderHtml = '';
        tableHeaderHtml = `
          <thead>
            <tr>
              <th>Ticker</th>
              <th class="stock-category">Category</th>
              <th class="stock-price">Last</th>
              <th class="stock-change">Change</th>
              <th class="stock-change-pct">Change%</th>
           	  <th class="stock-latest-volume">Volume</th>
            	<th class="stock-avg-total-volume">ADV</th>
              <th class="stock-mkt-cap">AUM</th>
              <th class="flow-yesterday">Flow T-1</th>
              <th class="flow-1m">Flow 1m</th>
              <th class="flow-3m">Flow 3m</th>
              <th class="stock-change-pct-1m">% Return 1m</th>
              <th class="stock-change-pct-3m">% Return 3m</th>              
            </tr>
          </thead>
        `

        let idx = 0;
        let tableBodyHtml = portfolio.items.map(item => {
          let symbol = item.ticker.toUpperCase();
          symbols.push(symbol);

          let html = `
            <tr data-symbol="${symbol}">
              <td class="stock-symbol"><a href="${symbolUrl(symbol)}" target="_blank">${symbol}</a></td>
              <td class="stock-category">${item.category}</td>
              <td class="stock-price"></td>
              <td class="stock-change"></td>
              <td class="stock-change-pct"></td>
              <td class="stock-latest-volume"></td>
              <td class="stock-avg-total-volume"></td>
              <td class="stock-mkt-cap"></td>
              <td class="flow-yesterday" original_numeric=${item.flowYesterday}>${signedFlows(item.flowYesterday)}</td>
              <td class="flow-1m" original_numeric=${item.flow1m}>${signedFlows(item.flow1m)}</td>
              <td class="flow-3m" original_numeric=${item.flow3m}>${signedFlows(item.flow3m)}</td> 
              <td class="stock-change-pct-1m" original_numeric=${item.tr1m}>${formatPercent(item.tr1m)}</td>
              <td class="stock-change-pct-3m" original_numeric=${item.tr3m}>${formatPercent(item.tr3m)}</td>                           
            </tr>
          `

          return html;
        }).join('');

        let portfolioDiv = document.createElement('div');

        portfolioDiv.innerHTML = `
          <details open>
            <summary><h2>${portfolio.name}</h2></summary>
            <table class="sortable" id="table-item-${portfolio_index}">${tableHeaderHtml}<tbody>${tableBodyHtml}</tbody></table>
          </details>
        `;

        containerDiv.appendChild(portfolioDiv);
      }



      function updateData(addTitle) {
        let numberOfBatches = Math.ceil(symbols.length / BATCH_SIZE);

        for (let i = 0; i < numberOfBatches; i++) {
          let symbolsBatch = symbols.slice(i * BATCH_SIZE, (i + 1) * BATCH_SIZE);
          updateDataForBatch(symbolsBatch, addTitle);
        }

        updatedDiv.innerHTML = `Data updated at ${(new Date()).toLocaleString()}`;
      }

      function sortTable(table_id,col_num) {
        var table, rows, switching, i, x, y, shouldSwitch;
        table = document.getElementById(table_id);
        switching = true;
        /* Make a loop that will continue until
        no switching has been done: */
        var header = table.getElementsByTagName("TH")[col_num];
        while (switching) {
          // Start by saying: no switching is done:
          switching = false;
          rows = table.getElementsByTagName("TR");
          /* Loop through all table rows (except the
          first, which contains table headers): */
          for (i = 1; i < (rows.length - 1); i++) {
            // Start by saying there should be no switching:
            shouldSwitch = false;
            /* Get the two elements you want to compare,
            one from current row and one from the next: */
            x = rows[i].getElementsByTagName("TD")[col_num];
            y = rows[i + 1].getElementsByTagName("TD")[col_num];
            // Check if the two rows should switch place:
            var yval = y.innerHTML;
            var xval = x.innerHTML;

            if( y.originalNumeric !== undefined )
               yval = y.originalNumeric
            else if(y.getAttribute("original_numeric") !== null)
              y.originalNumeric = parseFloat(y.getAttribute("original_numeric"))
              yval = y.originalNumeric 

            if( x.originalNumeric !== undefined )
               xval = x.originalNumeric
            else if(x.getAttribute("original_numeric") !== null)
              x.originalNumeric = parseFloat(x.getAttribute("original_numeric"))
              xval = x.originalNumeric 

            if(header.sortDir === 'desc'){
              if (xval > yval) {
                // I so, mark as a switch and break the loop:
                shouldSwitch= true;
                break;
              }
            }
            else {
              if (xval < yval) {
                // I so, mark as a switch and break the loop:
                shouldSwitch= true;
                break;
              }
            }
          }
          if (shouldSwitch) {
            /* If a switch has been marked, make the switch
            and mark that a switch has been done: */
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
          }
        }

        header.sortDir === 'desc' ? header.sortDir = 'asc' : header.sortDir = 'desc';
        return false;
      }



      function updateDataForBatch(symbols, addTitle) {
        let filters = ['latestPrice', 'latestVolume', 'avgTotalVolume','change', 'changePercent', 'marketCap'];
        if (addTitle) filters.push('companyName');
        let url = `${BASE_URL}?types=quote&symbols=${symbols.join(',')}&filter=${filters.join(',')}`;

        fetch(url).then(response => response.json()).then(json => {
          symbols.forEach(symbol => {
            let data = json[symbol];
            if (typeof(data) === 'undefined') return;

            let formattedPrice = formatQuote(data.quote.latestPrice);
            let formattedChange = data.quote.change.toLocaleString('en', {'minimumFractionDigits': 2});
            let formattedChangePercent = formatPercent(data.quote.changePercent);
            let formattedLatestVolume = formatNumberToWords(data.quote.latestVolume);
            let formattedAvgTotalVolume = formatNumberToWords(data.quote.avgTotalVolume)


            let formattedMarketCap = '$' + formatNumberToWords(data.quote.marketCap);
            let rgbColor = data.quote.changePercent > 0 ? '0,255,0' : '255,0,0';
            let rgbOpacity = Math.min(Math.abs(data.quote.changePercent) * 20, 1);

            document.querySelectorAll(`[data-symbol="${symbol}"] .stock-price`).forEach(e => {
              e.innerHTML = formattedPrice;
              e.originalNumeric = data.quote.latestPrice;
              e.setAttribute('style', `background-color: rgba(${rgbColor}, ${rgbOpacity})`);
            });

            document.querySelectorAll(`[data-symbol="${symbol}"] .stock-change`).forEach(e => {
              e.innerHTML = formattedChange;
              e.originalNumeric = data.quote.change;
              e.setAttribute('style', `background-color: rgba(${rgbColor}, ${rgbOpacity})`);
            });

            document.querySelectorAll(`[data-symbol="${symbol}"] .stock-latest-volume`).forEach(e => {
              e.innerHTML = formattedLatestVolume;
              e.originalNumeric = data.quote.latestVolume;
              e.setAttribute('style', `background-color: rgba(${rgbColor}, ${rgbOpacity})`);
            });

            document.querySelectorAll(`[data-symbol="${symbol}"] .stock-avg-total-volume`).forEach(e => {
              e.innerHTML = formattedAvgTotalVolume;
              e.originalNumeric = data.quote.avgTotalVolume;
              e.setAttribute('style', `background-color: rgba(${rgbColor}, ${rgbOpacity})`);
            });                      

            document.querySelectorAll(`[data-symbol="${symbol}"] .stock-change-pct`).forEach(e => {
              e.innerHTML = formattedChangePercent;
              e.originalNumeric = data.quote.changePercent;
              e.setAttribute('style', `background-color: rgba(${rgbColor}, ${rgbOpacity})`);
            });

            document.querySelectorAll(`[data-symbol="${symbol}"] .stock-mkt-cap`).forEach(e => {
              e.innerHTML = formattedMarketCap;
              e.originalNumeric = data.quote.marketCap;
              e.setAttribute('style', `background-color: rgba(${rgbColor}, ${rgbOpacity})`);
            });
   
            if (addTitle) {
              document.querySelectorAll(`[data-symbol="${symbol}"] .stock-symbol a`).forEach(e => {
                e.setAttribute('title', data.quote.companyName);
              });
            }
          });
        });
      }

      function portfoliosFromQueryParams() {
        if (!window.location.search) return;

        let params = new URLSearchParams(window.location.search);
        let portfolios = [];

        for (let p of params) {
          portfolios.push({'name': p[0], 'symbols': p[1].split(',')});
        }

        return portfolios;
      }

      function symbolUrl(symbol) {
        return `https://iextrading.com/apps/stocks/#/${symbol}`;
      }

      function formatQuote(value) {
        let options = {
          'minimumFractionDigits': 2,
          'style': 'currency',
          'currency': 'USD'
        };
        return value.toLocaleString('en', options);
      }

      function formatPercent(num) {
        return (num* 100).toFixed(1) + '%';
      }

      function signedFlows(flowNumber) {
          let formatted = formatNumberToWords(Math.abs(flowNumber));
          return flowNumber<0 ? '-$'+formatted : formatted;
      }

      function formatNumberToWords(marketCap) {
        let value, suffix;
        if (marketCap >= 1e12) {
          value = marketCap / 1e12;
          suffix = 'T';
        } else if (marketCap >= 1e9) {
          value = marketCap / 1e9;
          suffix = 'B';
        } else if (marketCap >= 1e6) {
          value = marketCap / 1e6;
          suffix = 'M';
        } else if (marketCap >= 1e3) {
          value = marketCap / 1e3;
          suffix = 'K';
        } else {
          value = marketCap;
          suffix = '';
        }

        let digits = value < 10 ? 1 : 0;

        return value.toFixed(digits) + suffix;
      }
    </script>
  </body>
</html>
